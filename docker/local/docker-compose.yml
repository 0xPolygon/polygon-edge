version: '3.5'

services:
  ## INITIALIZE GENESIS AND SECRETS
  init:
    build:
      context: ../../
      dockerfile: docker/local/Dockerfile
    command: ["init"]
    volumes:
      - node-1:/polygon-edge/data-1
      - node-2:/polygon-edge/data-2
      - node-3:/polygon-edge/data-3
      - node-4:/polygon-edge/data-4
      - genesis:/genesis
    networks:
      - polygon-edge-docker
  
  ## RUN NODES
  ## Nodes must have the same names as folders in genesis-legde
  node-1:
    build:
      context: ../../
      dockerfile: docker/local/Dockerfile
    command: ["server", "--data-dir", "/data", "--chain", "/genesis/genesis.json", "--grpc-address", "0.0.0.0:10000", "--libp2p", "0.0.0.0:10001", "--jsonrpc", "0.0.0.0:10002", "--seal"]
    depends_on:
      - init
    volumes:
      - node-1:/data
      - genesis:/genesis
    networks:
      - polygon-edge-docker
    restart: on-failure
    
  node-2:
    build:
      context: ../../
      dockerfile: docker/local/Dockerfile
    command: ["server", "--data-dir", "/data", "--chain", "/genesis/genesis.json", "--grpc-address", "0.0.0.0:10000", "--libp2p", "0.0.0.0:10001", "--jsonrpc", "0.0.0.0:10002", "--seal"]
    depends_on:
      - init
    volumes:
      - node-2:/data
      - genesis:/genesis
    networks:
      - polygon-edge-docker
    restart: on-failure
    
  node-3:
    build:
      context: ../../
      dockerfile: docker/local/Dockerfile
    command: ["server", "--data-dir", "/data", "--chain", "/genesis/genesis.json", "--grpc-address", "0.0.0.0:10000", "--libp2p", "0.0.0.0:10001", "--jsonrpc", "0.0.0.0:10002", "--seal"]
    depends_on:
      - init
    volumes:
      - node-3:/data
      - genesis:/genesis
    networks:
      - polygon-edge-docker
    restart: on-failure
    
  node-4:
    build:
      context: ../../
      dockerfile: docker/local/Dockerfile
    command: ["server", "--data-dir", "/data", "--chain", "/genesis/genesis.json", "--grpc-address", "0.0.0.0:10000", "--libp2p", "0.0.0.0:10001", "--jsonrpc", "0.0.0.0:10002", "--seal"]
    depends_on:
      - init
    volumes:
      - node-4:/data
      - genesis:/genesis
    networks:
      - polygon-edge-docker
    restart: on-failure

networks:
  polygon-edge-docker:
    driver: bridge
    name: polygon-edge-docker

volumes:
  node-1:
  node-2:
  node-3:
  node-4:
  genesis:
